@using System.Text
@using Telerik.Documents.Common
@using Telerik.Documents.SpreadsheetStreaming
@using Telerik.Windows.Documents.Spreadsheet.FormatProviders.OpenXml.Xlsx
@using Telerik.Windows.Documents.Spreadsheet.FormatProviders.TextBased.Csv
@using Telerik.Windows.Documents.Spreadsheet.Model

<p>@message</p>
<TelerikSpreadsheet Data="xls" />

@code {

    [Parameter, EditorRequired]
    public string? FilePath { get; set; }

    byte[]? xls;
    string message = "Previewing the first 1000 records";

    protected override void OnInitialized()
    {
        Workbook wb = GetWorkbookPreviewFromCsv();
        ConvertWorkbookToXls(wb);
    }

    void ConvertWorkbookToXls(Workbook wb)
    {
        using (MemoryStream xlsxStream = new MemoryStream())
        {
            new XlsxFormatProvider().Export(wb, xlsxStream);
            xls = xlsxStream.ToArray();
        };
    }

    private Workbook GetWorkbookPreviewFromCsv()
    {
        if (FilePath is null) throw new InvalidOperationException("FilePath parameter must be set.");

        var dataString = System.IO.File.ReadLines(FilePath).Take(1000);
        byte[] data = Encoding.UTF8.GetBytes(string.Join(Environment.NewLine, dataString));
        return new CsvFormatProvider().Import(new MemoryStream(data));
    }
}